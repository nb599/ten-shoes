name: Lighthouse Reports

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  lighthouse-reports:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Build application
        run: npm run build
        env:
          AUTH_SECRET: lighthouse-test-secret-32-chars-long
          DATABASE_URL: postgresql://test:test@localhost:5432/test

      - name: Run Lighthouse CI (Mobile)
        run: |
          echo "Running mobile LHCI..."
          npx lhci autorun
          
          # Check and copy results
          mkdir -p lighthouse-reports
          if [ -f .lighthouseci/*.html ]; then
            cp .lighthouseci/*.html lighthouse-reports/mobile.html
            echo "✅ Mobile HTML report generated"
          else
            echo "❌ No mobile HTML generated, using direct Lighthouse"
            npx lighthouse http://localhost:3000 --output=html --output-path=lighthouse-reports/mobile.html --emulated-form-factor=mobile --chrome-flags="--headless --no-sandbox"
          fi
          
      - name: Run Lighthouse CI (Desktop)  
        run: |
          echo "Running desktop LHCI..."
          rm -rf .lighthouseci  # Clean up
          npx lhci autorun --config=lighthouserc.desktop.js
          
          # Check and copy results
          if [ -f .lighthouseci/*.html ]; then
            cp .lighthouseci/*.html lighthouse-reports/desktop.html
            echo "✅ Desktop HTML report generated"  
          else
            echo "❌ No desktop HTML generated, using direct Lighthouse"
            npm start &
            sleep 10
            npx lighthouse http://localhost:3000 --output=html --output-path=lighthouse-reports/desktop.html --preset=desktop --chrome-flags="--headless --no-sandbox"
            pkill -f "npm start"
          fi
          
          # Verify all files
          ls -la lighthouse-reports/
        env:
          AUTH_SECRET: lighthouse-test-secret-32-chars-long
          DATABASE_URL: postgresql://test:test@localhost:5432/test

      - name: Create Pages structure
        run: |
          mkdir -p docs/lighthouse/mobile docs/lighthouse/desktop
          
          # Copy reports to Pages structure (with error handling)
          if [ -f lighthouse-reports/mobile.html ]; then
            cp lighthouse-reports/mobile.html docs/lighthouse/mobile/lhr-1.html
            echo "✅ Mobile report copied"
          else
            echo "❌ Mobile report missing, creating placeholder"
            echo "<h1>Mobile report not generated</h1><p>Check Actions logs for details.</p>" > docs/lighthouse/mobile/lhr-1.html
          fi
          
          if [ -f lighthouse-reports/desktop.html ]; then
            cp lighthouse-reports/desktop.html docs/lighthouse/desktop/lhr-1.html  
            echo "✅ Desktop report copied"
          else
            echo "❌ Desktop report missing, creating placeholder"
            echo "<h1>Desktop report not generated</h1><p>Check Actions logs for details.</p>" > docs/lighthouse/desktop/lhr-1.html
          fi
          
          # Create main dashboard
          cat > docs/lighthouse/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>Lighthouse 性能报告</title>
              <meta charset="UTF-8">
              <style>
                  body { font-family: system-ui; max-width: 800px; margin: 50px auto; padding: 20px; }
                  .report-link { display: block; padding: 15px; margin: 10px 0; background: #f5f5f5; text-decoration: none; color: #333; border-radius: 8px; }
                  .report-link:hover { background: #e5e5e5; }
                  h1 { color: #333; }
              </style>
          </head>
          <body>
              <h1>🚀 Lighthouse 性能报告</h1>
              <p>首页性能测试结果</p>
              
              <a href="./mobile/lhr-1.html" class="report-link">
                  📱 移动端报告
              </a>
              
              <a href="./desktop/lhr-1.html" class="report-link">
                  🖥️ 桌面端报告
              </a>
              
              <p><small>更新时间: $(date)</small></p>
          </body>
          </html>
          EOF
          
          # List final structure
          find docs/lighthouse -type f

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-reports
          path: lighthouse-reports/
          retention-days: 30

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/lighthouse

      - name: Deploy Pages
        uses: actions/deploy-pages@v4