name: Lighthouse CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write
  checks: write

jobs:
  lighthouse-mobile:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Build application
        run: npm run build
        env:
          AUTH_SECRET: ${{ secrets.AUTH_SECRET || 'lighthouse-ci-test-secret-key-32-chars' }}
          DATABASE_URL: ${{ secrets.DATABASE_URL || '' }}

      - name: Run Lighthouse CI (Mobile)
        run: npx lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
          AUTH_SECRET: ${{ secrets.AUTH_SECRET || 'lighthouse-ci-test-secret-key-32-chars' }}

      - name: Upload Lighthouse results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-results-mobile
          path: .lighthouseci/
          retention-days: 30

  lighthouse-desktop:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Build application
        run: npm run build
        env:
          AUTH_SECRET: ${{ secrets.AUTH_SECRET || 'lighthouse-ci-test-secret-key-32-chars' }}
          DATABASE_URL: ${{ secrets.DATABASE_URL || '' }}

      - name: Run Lighthouse CI (Desktop)
        run: npx lhci autorun --config=lighthouserc.desktop.js
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
          AUTH_SECRET: ${{ secrets.AUTH_SECRET || 'lighthouse-ci-test-secret-key-32-chars' }}

      - name: Upload Lighthouse results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-results-desktop
          path: .lighthouseci/
          retention-days: 30

  generate-reports:
    runs-on: ubuntu-latest
    needs: [lighthouse-mobile, lighthouse-desktop]
    if: always() && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Mobile Results
        uses: actions/download-artifact@v4
        with:
          name: lighthouse-results-mobile
          path: ./reports/mobile

      - name: Download Desktop Results
        uses: actions/download-artifact@v4
        with:
          name: lighthouse-results-desktop
          path: ./reports/desktop

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Generate Dashboard
        run: |
          # åˆ›å»ºæŠ¥å‘Šç›®å½•ç»“æ„
          mkdir -p docs/lighthouse/{mobile,desktop}

          # å¤åˆ¶æŠ¥å‘Šæ–‡ä»¶
          cp -r reports/mobile/* docs/lighthouse/mobile/ 2>/dev/null || true
          cp -r reports/desktop/* docs/lighthouse/desktop/ 2>/dev/null || true

          # ç”Ÿæˆç´¢å¼•é¡µé¢
          cat > docs/lighthouse/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="zh-CN">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>å¤©ä¹¦ - Lighthouse æ€§èƒ½æŠ¥å‘Š</title>
              <style>
                  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 0; padding: 20px; background: #f6f8fa; }
                  .container { max-width: 1200px; margin: 0 auto; }
                  .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
                  .reports { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
                  .report-section { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
                  .report-list { list-style: none; padding: 0; }
                  .report-list li { margin: 10px 0; }
                  .report-list a { color: #0366d6; text-decoration: none; padding: 8px 12px; display: block; border-radius: 4px; border: 1px solid #e1e4e8; }
                  .report-list a:hover { background: #f6f8fa; }
                  .meta { color: #586069; font-size: 14px; margin-top: 20px; }
                  .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; }
                  .badge.mobile { background: #e1f5fe; color: #01579b; }
                  .badge.desktop { background: #f3e5f5; color: #4a148c; }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>ğŸš€ å¤©ä¹¦ - Lighthouse æ€§èƒ½æŠ¥å‘Š</h1>
                      <p>è‡ªåŠ¨åŒ–æ€§èƒ½ç›‘æ§ â€¢ ç”Ÿæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')</p>
                      <p>æäº¤: <code>${{ github.sha }}</code> â€¢ åˆ†æ”¯: <code>${{ github.ref_name }}</code></p>
                  </div>
                  
                  <div class="reports">
                      <div class="report-section">
                          <h2><span class="badge mobile">ğŸ“±</span> ç§»åŠ¨ç«¯æŠ¥å‘Š</h2>
                          <p>æ¨¡æ‹Ÿ 3G ç½‘ç»œç¯å¢ƒä¸‹çš„ç§»åŠ¨è®¾å¤‡æ€§èƒ½æµ‹è¯•</p>
                          <ul class="report-list" id="mobile-reports">
                              <li>æ­£åœ¨åŠ è½½æŠ¥å‘Š...</li>
                          </ul>
                      </div>
                      
                      <div class="report-section">
                          <h2><span class="badge desktop">ğŸ–¥ï¸</span> æ¡Œé¢ç«¯æŠ¥å‘Š</h2>
                          <p>å¿«é€Ÿç½‘ç»œç¯å¢ƒä¸‹çš„æ¡Œé¢è®¾å¤‡æ€§èƒ½æµ‹è¯•</p>
                          <ul class="report-list" id="desktop-reports">
                              <li>æ­£åœ¨åŠ è½½æŠ¥å‘Š...</li>
                          </ul>
                      </div>
                  </div>
                  
                  <div class="meta">
                      <p><strong>æµ‹è¯•é¡µé¢:</strong> é¦–é¡µã€AIæ–‡ç« ã€Agentæ–‡ç« ã€ç™»å½•é¡µã€æ³¨å†Œé¡µ</p>
                      <p><strong>è¿è¡Œæ¬¡æ•°:</strong> æ¯é¡µé¢ 3 æ¬¡ï¼Œå–ä¸­ä½æ•°</p>
                      <p><strong>æ›´æ–°é¢‘ç‡:</strong> æ¯æ¬¡æ¨é€åˆ° main åˆ†æ”¯è‡ªåŠ¨æ›´æ–°</p>
                  </div>
              </div>
              
              <script>
                  // åŠ¨æ€åŠ è½½æŠ¥å‘Šåˆ—è¡¨
                  function loadReports() {
                      const pages = ['é¦–é¡µ', 'AIå‰ç«¯æŠ€æœ¯', 'Agentè®¾è®¡æ¨¡å¼', 'ç™»å½•é¡µ', 'æ³¨å†Œé¡µ'];
                      const mobileList = document.getElementById('mobile-reports');
                      const desktopList = document.getElementById('desktop-reports');
                      
                      mobileList.innerHTML = '';
                      desktopList.innerHTML = '';
                      
                      pages.forEach((page, index) => {
                          const mobileItem = document.createElement('li');
                          const desktopItem = document.createElement('li');
                          
                          mobileItem.innerHTML = `<a href="./mobile/lhr-${index + 1}.html" target="_blank">${page}</a>`;
                          desktopItem.innerHTML = `<a href="./desktop/lhr-${index + 1}.html" target="_blank">${page}</a>`;
                          
                          mobileList.appendChild(mobileItem);
                          desktopList.appendChild(desktopItem);
                      });
                  }
                  
                  loadReports();
              </script>
          </body>
          </html>
          EOF

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/lighthouse

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  performance-summary:
    runs-on: ubuntu-latest
    needs: [lighthouse-mobile, lighthouse-desktop]
    if: always()

    steps:
      - name: Download Mobile Results
        uses: actions/download-artifact@v4
        with:
          name: lighthouse-results-mobile
          path: ./mobile-results

      - name: Download Desktop Results
        uses: actions/download-artifact@v4
        with:
          name: lighthouse-results-desktop
          path: ./desktop-results

      - name: Performance Summary
        run: |
          echo "## ğŸš€ Lighthouse CI æ€§èƒ½æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š æµ‹è¯•æ¦‚è§ˆ" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“± ç§»åŠ¨ç«¯æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
          echo "- **ç½‘ç»œ**: 3G æ¨¡æ‹Ÿ (1.6 Mbps, 150ms RTT)" >> $GITHUB_STEP_SUMMARY
          echo "- **è®¾å¤‡**: ç§»åŠ¨è®¾å¤‡æ¨¡æ‹Ÿ" >> $GITHUB_STEP_SUMMARY
          echo "- **é¡µé¢**: é¦–é¡µã€AIæ–‡ç« ã€Agentæ–‡ç« ã€ç™»å½•é¡µã€æ³¨å†Œé¡µ" >> $GITHUB_STEP_SUMMARY
          echo "- **è¿è¡Œ**: æ¯é¡µé¢ 3 æ¬¡ï¼Œå–ä¸­ä½æ•°" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ–¥ï¸ æ¡Œé¢ç«¯æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
          echo "- **ç½‘ç»œ**: å¿«é€Ÿç½‘ç»œ (10 Mbps, 40ms RTT)" >> $GITHUB_STEP_SUMMARY
          echo "- **è®¾å¤‡**: æ¡Œé¢è®¾å¤‡" >> $GITHUB_STEP_SUMMARY
          echo "- **é¡µé¢**: é¦–é¡µã€AIæ–‡ç« ã€Agentæ–‡ç« ã€ç™»å½•é¡µã€æ³¨å†Œé¡µ" >> $GITHUB_STEP_SUMMARY
          echo "- **è¿è¡Œ**: æ¯é¡µé¢ 3 æ¬¡ï¼Œå–ä¸­ä½æ•°" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ¯ æ€§èƒ½é˜ˆå€¼" >> $GITHUB_STEP_SUMMARY
          echo "| æŒ‡æ ‡ | ç§»åŠ¨ç«¯é˜ˆå€¼ | æ¡Œé¢ç«¯é˜ˆå€¼ | çº§åˆ« |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----------|-----------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| æ€§èƒ½åˆ†æ•° | â‰¥70 | â‰¥80 | Warning |" >> $GITHUB_STEP_SUMMARY
          echo "| å¯è®¿é—®æ€§ | â‰¥90 | â‰¥95 | Error |" >> $GITHUB_STEP_SUMMARY
          echo "| æœ€ä½³å®è·µ | â‰¥80 | â‰¥90 | Warning |" >> $GITHUB_STEP_SUMMARY
          echo "| SEO | â‰¥90 | â‰¥95 | Error |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ˆ Core Web Vitals" >> $GITHUB_STEP_SUMMARY
          echo "| æŒ‡æ ‡ | ç§»åŠ¨ç«¯ | æ¡Œé¢ç«¯ | è¯´æ˜ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|--------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| FCP | â‰¤2000ms | â‰¤1200ms | é¦–æ¬¡å†…å®¹ç»˜åˆ¶ |" >> $GITHUB_STEP_SUMMARY
          echo "| LCP | â‰¤2500ms | â‰¤1500ms | æœ€å¤§å†…å®¹ç»˜åˆ¶ |" >> $GITHUB_STEP_SUMMARY
          echo "| CLS | â‰¤0.1 | â‰¤0.05 | ç´¯ç§¯å¸ƒå±€åç§» |" >> $GITHUB_STEP_SUMMARY
          echo "| TBT | â‰¤300ms | â‰¤150ms | æ€»é˜»å¡æ—¶é—´ |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ ä¸‹è½½æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "- [ç§»åŠ¨ç«¯æŠ¥å‘Šæ„ä»¶](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- [æ¡Œé¢ç«¯æŠ¥å‘Šæ„ä»¶](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "- [åœ¨çº¿æŠ¥å‘Šé¢æ¿](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*ğŸ¤– æ­¤æŠ¥å‘Šç”± Lighthouse CI è‡ªåŠ¨ç”Ÿæˆ*"
